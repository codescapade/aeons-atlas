name: CI
on:
  push:
    tags:
      - "v*"

jobs:

  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - uses: krdlab/setup-haxe@v1
        with:
          haxe-version: 4.2.5

      - name: Set HAXEPATH
        run: echo "HAXEPATH=$Env:HAXE_STD_PATH\.." >> $Env:GITHUB_ENV

      - name: Install Haxe dependencies
        run: |
          haxelib install format 3.5.0 --quiet
          haxelib install buddy 2.13.0 --quiet

      - name: Run Tests
        run: haxe tests.hxml

  build-windows:
    needs: run-tests
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2

      - uses: krdlab/setup-haxe@v1
        with:
          haxe-version: 4.2.5

      - name: Set HAXEPATH
        run: echo "HAXEPATH=$Env:HAXE_STD_PATH\.." >> $Env:GITHUB_ENV

      - name: Install Haxe dependencies
        run: |
          haxelib install hxcpp --quiet
          haxelib install format 3.5.0 --quiet

      - name: Build Aeons Atlas
        run: haxe build-windows.hxml

      - uses: actions/upload-artifact@v2
        with:
          name: AeonsAtlas-Windows
          path: build\windows\AeonsAtlasWin.exe
          if-no-files-found: error

  build-macos:
    needs: run-tests
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - uses: krdlab/setup-haxe@v1
        with:
          haxe-version: 4.2.5

      - name: Set HAXEPATH
        run: echo "HAXEPATH=$Env:HAXE_STD_PATH\.." >> $Env:GITHUB_ENV

      - name: Install Haxe dependencies
        run: |
          haxelib install hxcpp --quiet
          haxelib install format 3.5.0 --quiet

      - name: Build Aeons Atlas
        run: haxe build-macos.hxml

      - uses: actions/upload-artifact@v2
        with:
          name: AeonsAtlas-MacOS
          path: build/macos/AeonsAtlasMac
          if-no-files-found: error


  build-linux:
    needs: run-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - uses: krdlab/setup-haxe@v1
        with:
          haxe-version: 4.2.5

      - name: Set HAXEPATH
        run: echo "HAXEPATH=$Env:HAXE_STD_PATH\.." >> $Env:GITHUB_ENV

      - name: Install Haxe dependencies
        run: |
          haxelib install hxcpp --quiet
          haxelib install format 3.5.0 --quiet

      - name: Build Aeons Atlas
        run: haxe build-linux.hxml

      - uses: actions/upload-artifact@v2
        with:
          name: AeonsAtlas-Linux
          path: build/linux/AeonsAtlasLinux
          if-no-files-found: error


  tagged-release:
    needs: [build-windows, build-macos, build-linux]
    name: "Tagged Release"
    runs-on: "ubuntu-latest"

    steps:
      - uses: actions/download-artifact@v2
      - name: Display fetched artifacts
        run: ls -R

      - uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          prerelease: false
          files: |
            AeonsAtlasWin.exe/AeonsAtlasWin.exe
            AeonsAtlasMac/AeonsAtlasMac
            AeonsAtlasLinux/AeonsAtlasLinux